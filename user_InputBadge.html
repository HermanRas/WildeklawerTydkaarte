<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Start of App JS -->
    <script src="App/dbAPI.js"></script>
    <script src="App/app.js"></script>
    <!-- End Of App JS -->
    <script src="JS/jquery-3.6.0.min.js"></script>
    <script>
        loadData('_header.html', '', 'HEAD');
        // loadScript("./service-worker-install.js");
        // loadScript("./service-worker.js");
    </script>
</head>

<body>
    <!-- NAV BAR -->
    <div id="nav">Loading... Menu Data</div>
    <script type="text/JavaScript">
        loadData('_nav.html','nav'); //load user nav
        // $.getScript("App/navAdmin.js"); //load admin buttons if admin
    </script>
    <script>
        // Check that service workers are supported
        if ('serviceWorker' in navigator) {
            // Use the window load event to keep the page load performant
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js');
            });
        }
    </script>

    <!-- Page Title -->
    <!-- Main Content -->

    <!-- 
    #################################################################
    ## show camera and Code if found
    #################################################################
    -->
    <!-- 
        #################################################################
        ## show camera and Code if found
        #################################################################
     -->
    <form action="#" method="POST">
        <h1 class="bg-wk"><img style="height:1.5em;" src="Img/klok.png" class="rounded m-1 p-1" alt="Klok">Klok</h1>
        <div class="container">
            <script src="JS/sweetalert2.10.js"></script>
            <h3>Lees al die QR Kodes</h3>
            <video style="max-width:300px; max-height:180px;display: block; margin: 0 auto;" id="qr-video"></video>
            <br>
            <h3 class="bg-primary p-1 m-1">Werker Lys:</h3>
            <ul class="text-xs bg-white" id="cam-qr-result"></ul>
            <div id="butDiv"></div>
        </div>
    </form>
    <script>
        // clearItem if error
        function clearItem(e) {
            e.parentElement.parentElement.removeChild(e.parentElement);
        }
    </script>

    <!-- Page Level Scripts -->
    <script type="module">
        //import plugins
        import QrScanner from "./JS/qr-scanner.min.js";
        QrScanner.WORKER_PATH = './JS/qr-scanner-worker.min.js';

        //set defaults
        const video = document.getElementById('qr-video');
        const camQrResult = document.getElementById('cam-qr-result');
        var lastResult = '';

        //run scan
        function setResult(label, result) {
            if (lastResult == result) {
                scanner.start();
            } else {
                lastResult = result;
                var cn = result.split(":");
                var contract_end = new Date(cn[2])
                var today = new Date();
                today.setHours(0, 0, 0, 0);
                if (contract_end < today) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Die Kontrak het verval!'
                    })
                } else {
                    label.innerHTML =
                        '<li>' +
                        '<input type="hidden" name="CN[]" value="' + cn[0] + '">' +
                        '<input type="hidden" name="name[]" value="' + result + '">' +
                        result +
                        '<input type="button" class="btn-sm btn-close" onclick="clearItem(this);" >' +
                        '</li>' +
                        label.innerHTML;
                    document.getElementById('butDiv').innerHTML = '<a href="user_InputClock.html?User=' + cn[0] +
                        '" class="btn btn-secondary">Stuur</a>';

                    label.style.color = 'orange';
                    clearTimeout(label.highlightTimeout);
                    label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 100);
                }
                scanner.start();
            }
        }


        // ####### Web Cam Scanning #######
        const scanner = new QrScanner(video, result => setResult(camQrResult, result));
        scanner.start();
        scanner.setInversionMode('original');
    </script>

    <!-- Footer -->
    <script>
        loadData('_footer.html', '', 'BODY');
        loadScript("JS/bootstrap.bundle.min.js");
    </script>
</body>

</html>